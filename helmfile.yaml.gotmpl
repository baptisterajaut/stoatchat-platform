# ===========================================
# HELM REPOSITORIES
# ===========================================
repositories:
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  - name: minio
    url: https://charts.min.io/
  - name: jetstack
    url: https://charts.jetstack.io
  - name: haproxytech
    url: https://haproxytech.github.io/helm-charts
  - name: emberstack
    url: https://emberstack.github.io/helm-charts
  - name: livekit
    url: https://helm.livekit.io

# ===========================================
# HELM DEFAULTS
# ===========================================
helmDefaults:
  wait: true
  waitForJobs: true
  timeout: 600
  createNamespace: true

# ===========================================
# ENVIRONMENTS
# ===========================================
environments:
  local:
    values:
      - environments/_defaults.yaml
      - versions/infra-versions.yaml
      - versions/stoatchat-versions.yaml
      - environments/local.yaml
      - environments/vapid.secret.yaml
      - environments/files.secret.yaml

  compose:
    values:
      - environments/_defaults.yaml
      - versions/infra-versions.yaml
      - versions/stoatchat-versions.yaml
      - environments/compose.yaml
      - environments/vapid.secret.yaml
      - environments/files.secret.yaml

  # Template for remote deployments â€” copy and adapt:
  # my-instance:
  #   values:
  #     - environments/_defaults.yaml
  #     - versions/infra-versions.yaml
  #     - versions/stoatchat-versions.yaml
  #     - environments/my-instance.yaml
  #     - environments/my-instance.secret-overrides.yaml  # optional
  #     - environments/vapid.secret.yaml
  #     - environments/files.secret.yaml

---
# ===========================================
# RELEASES
# ===========================================
releases:
  # -------------------------------------------
  # CERT-MANAGER
  # -------------------------------------------
  - name: cert-manager
    namespace: cert-manager
    chart: jetstack/cert-manager
    version: {{ .Values.infraChartVersions.certManager | quote }}
    condition: certManager.enabled
    labels:
      category: infrastructure
    values:
      - values/cert-manager.yaml.gotmpl

  # -------------------------------------------
  # HAPROXY INGRESS CONTROLLER
  # -------------------------------------------
  - name: haproxy-ingress
    namespace: haproxy-controller
    chart: haproxytech/kubernetes-ingress
    version: {{ .Values.infraChartVersions.haproxy | quote }}
    condition: ingress.enabled
    labels:
      category: infrastructure
    values:
      - values/haproxy-ingress.yaml.gotmpl

  # -------------------------------------------
  # REFLECTOR
  # -------------------------------------------
  - name: reflector
    namespace: reflector
    chart: emberstack/reflector
    version: {{ .Values.infraChartVersions.reflector | quote }}
    condition: reflector.enabled
    labels:
      category: infrastructure

  # -------------------------------------------
  # MONGODB
  # -------------------------------------------
  - name: stoatchat-mongodb
    namespace: stoatchat-mongodb
    chart: bitnami/mongodb
    version: {{ .Values.infraChartVersions.mongodb | quote }}
    condition: mongodb.enabled
    labels:
      category: infrastructure
    values:
      - values/mongodb.yaml.gotmpl

  # -------------------------------------------
  # REDIS
  # -------------------------------------------
  - name: redis
    namespace: stoatchat-redis
    chart: bitnami/redis
    version: {{ .Values.infraChartVersions.redis | quote }}
    condition: redis.enabled
    labels:
      category: infrastructure
    values:
      - values/redis.yaml.gotmpl

  # -------------------------------------------
  # RABBITMQ (official image, not bitnami)
  # -------------------------------------------
  - name: stoatchat-rabbitmq
    namespace: stoatchat-rabbitmq
    chart: ./helm/stoatchat-app
    condition: rabbitmq.enabled
    labels:
      category: infrastructure
    values:
      - values/rabbitmq.yaml.gotmpl

  # -------------------------------------------
  # MINIO
  # -------------------------------------------
  - name: minio
    namespace: stoatchat-minio
    chart: minio/minio
    version: {{ .Values.infraChartVersions.minio | quote }}
    condition: minio.enabled
    labels:
      category: infrastructure
    values:
      - values/minio.yaml.gotmpl

  # -------------------------------------------
  # LIVEKIT
  # -------------------------------------------
  - name: livekit
    namespace: stoatchat-livekit
    chart: livekit/livekit-server
    version: {{ .Values.infraChartVersions.livekit | quote }}
    condition: livekit.enabled
    needs:
      - stoatchat-config/stoatchat-config
      {{- if .Values.redis.enabled }}
      - stoatchat-redis/redis
      {{- end }}
    labels:
      category: infrastructure
    values:
      - values/livekit.yaml.gotmpl

  # -------------------------------------------
  # STOATCHAT CONFIGURATION
  # -------------------------------------------
  - name: stoatchat-config
    namespace: stoatchat-config
    chart: ./helm/stoatchat-config
    needs:
      {{- if .Values.certManager.enabled }}
      - cert-manager/cert-manager
      {{- end }}
      {{- if .Values.reflector.enabled }}
      - reflector/reflector
      {{- end }}
    labels:
      category: configuration
    values:
      - values/stoatchat-config.yaml.gotmpl

  # -------------------------------------------
  # STOATCHAT SERVICES
  # -------------------------------------------
  {{- $infraNeeds := list "stoatchat-config/stoatchat-config" }}
  {{- if .Values.mongodb.enabled }}{{ $infraNeeds = append $infraNeeds "stoatchat-mongodb/stoatchat-mongodb" }}{{ end }}
  {{- if .Values.redis.enabled }}{{ $infraNeeds = append $infraNeeds "stoatchat-redis/redis" }}{{ end }}
  {{- if .Values.rabbitmq.enabled }}{{ $infraNeeds = append $infraNeeds "stoatchat-rabbitmq/stoatchat-rabbitmq" }}{{ end }}
  {{- if .Values.minio.enabled }}{{ $infraNeeds = append $infraNeeds "stoatchat-minio/minio" }}{{ end }}

  - name: stoatchat-api
    namespace: stoatchat
    chart: ./helm/stoatchat-app
    condition: apps.api.enabled
    needs: {{ $infraNeeds | toYaml | nindent 6 }}
    labels:
      category: application
      app: api
    values:
      - values/api.yaml.gotmpl

  - name: stoatchat-events
    namespace: stoatchat
    chart: ./helm/stoatchat-app
    condition: apps.events.enabled
    needs: {{ $infraNeeds | toYaml | nindent 6 }}
    labels:
      category: application
      app: events
    values:
      - values/events.yaml.gotmpl

  - name: stoatchat-file-server
    namespace: stoatchat
    chart: ./helm/stoatchat-app
    condition: apps.fileServer.enabled
    needs: {{ $infraNeeds | toYaml | nindent 6 }}
    labels:
      category: application
      app: file-server
    values:
      - values/file-server.yaml.gotmpl

  - name: stoatchat-proxy
    namespace: stoatchat
    chart: ./helm/stoatchat-app
    condition: apps.proxy.enabled
    needs:
      - stoatchat-config/stoatchat-config
    labels:
      category: application
      app: proxy
    values:
      - values/proxy.yaml.gotmpl

  - name: stoatchat-gifbox
    namespace: stoatchat
    chart: ./helm/stoatchat-app
    condition: apps.gifbox.enabled
    needs:
      - stoatchat-config/stoatchat-config
    labels:
      category: application
      app: gifbox
    values:
      - values/gifbox.yaml.gotmpl

  - name: stoatchat-crond
    namespace: stoatchat
    chart: ./helm/stoatchat-app
    condition: apps.crond.enabled
    needs: {{ $infraNeeds | toYaml | nindent 6 }}
    labels:
      category: application
      app: crond
    values:
      - values/crond.yaml.gotmpl

  - name: stoatchat-pushd
    namespace: stoatchat
    chart: ./helm/stoatchat-app
    condition: apps.pushd.enabled
    needs: {{ $infraNeeds | toYaml | nindent 6 }}
    labels:
      category: application
      app: pushd
    values:
      - values/pushd.yaml.gotmpl

  - name: stoatchat-voice-ingress
    namespace: stoatchat
    chart: ./helm/stoatchat-app
    condition: apps.voiceIngress.enabled
    needs:
      {{- range $infraNeeds }}
      - {{ . }}
      {{- end }}
      {{- if .Values.livekit.enabled }}
      - stoatchat-livekit/livekit
      {{- end }}
    labels:
      category: application
      app: voice-ingress
    values:
      - values/voice-ingress.yaml.gotmpl

  - name: stoatchat-client
    namespace: stoatchat
    chart: ./helm/stoatchat-app
    condition: apps.client.enabled
    needs:
      - stoatchat-config/stoatchat-config
    labels:
      category: application
      app: client
    values:
      - values/client.yaml.gotmpl
